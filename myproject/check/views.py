from flask import (Blueprint, render_template,
                     redirect, url_for, request,
                     flash, abort)
from werkzeug.utils import secure_filename
from flask_login import login_required
from datetime import datetime

import os
import sys

sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from myproject import db, app
from myproject.models import Malware, History, generate_file_hash
from myproject.check.forms import SelectFileForm, MalwareRegistrationForm

check_blueprint = Blueprint('check',
                            __name__,
                            template_folder='templates/check')


@check_blueprint.route('/check', methods=['GET', 'POST'])
def upload():

    form = SelectFileForm()
    flag = ''
    name = ''

    if form.validate_on_submit():

        # Bad way !!!
        f = form.target_file.data.filename
        filename = secure_filename(f)
        # f.save(os.path.join(
        #     check_blueprint.instance_path, 'files', filename
        # ))
        flash('Successfully uploaded!')

        hash_val = generate_file_hash(f)
        malware = Malware.query.filter_by(malware_hash=hash_val).first()

        if malware is not None:
            flag = 'True'
            name = malware.malware_name
        else:
            flag = 'False'

        # result = History(is_malware=str(flag), file_hash=hash_val)
        result = History(is_malware=flag, hash_val=hash_val)

        db.session.add(result)
        db.session.commit()

    return render_template('select_file.html', form=form, flag=flag, name=name)

@check_blueprint.route('/addmalware', methods=['GET', 'POST'])
@login_required
def malware_register():
    form = MalwareRegistrationForm()

    if form.validate_on_submit():

        # Bad way !!!
        malware = Malware(malware_name=form.malware_name.data,
                          malware_file=form.malware_file.data.filename)

        db.session.add(malware)
        db.session.commit()
        flash('Successfully registerd.')
        return redirect(url_for('index'))

    return render_template('register_malware.html', form=form)

@check_blueprint.route('/result')
@login_required
def see_result():
    form = SelectFileForm()